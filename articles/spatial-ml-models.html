<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Running spatial machine learning models • mbg</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Figtree-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><link href="../deps/KaTex-0.16.10/katex.min.css" rel="stylesheet">
<script src="../deps/KaTex-0.16.10/katex.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Running spatial machine learning models">
<link rel="icon" type="image/png" href="favicon-96x96.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mbg</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/mbg.html">Getting started</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-more-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">More tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-more-tutorials">
<li><a class="dropdown-item" href="../articles/spatial-ml-models.html">Running spatial ML models</a></li>
    <li><a class="dropdown-item" href="../articles/all-model-options.html">All MBG model runner options</a></li>
    <li><a class="dropdown-item" href="../articles/model-comparison.html">Model validation and comparison</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/henryspatialanalysis/mbg/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Running spatial machine learning models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/henryspatialanalysis/mbg/blob/main/vignettes/spatial-ml-models.Rmd" class="external-link"><code>vignettes/spatial-ml-models.Rmd</code></a></small>
      <div class="d-none name"><code>spatial-ml-models.Rmd</code></div>
    </div>

    
    
<p>The default MBG setup models a uniform linear relationship between
each covariate and the outcome in modeling space. This assumption may
not always hold: there may be nonlinear relationships, spatially-varying
relationships, and covariate interactions that affect the outcome. If we
want to capture the nuances of these predictor relationships without
over-fitting our model, we can turn to machine learning (ML) algorithms
that are intended to fit over a high-dimensional feature space.</p>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>In this tutorial, we will run multiple machine learning models using
point-georeferenced outcome data and raster covariate data, then apply
the ML model predictions to generate raster predictions across the
prediction space. To begin, load the <code>mbg</code> package and helper
packages for data manipulation, then load the example data. Generate a
raster of the full prediction space using the
<code><a href="../reference/build_id_raster.html">build_id_raster()</a></code> function.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://henryspatialanalysis.github.io/mbg/">mbg</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Load data</span></span>
<span><span class="co"># Outcome: child stunting</span></span>
<span><span class="va">outcomes</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata/child_stunting.csv'</span>, package <span class="op">=</span> <span class="st">'mbg'</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Spatial covariates, including an intercept</span></span>
<span><span class="va">covariates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  access <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata/access.tif'</span>, package <span class="op">=</span> <span class="st">'mbg'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  evi <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata/evi.tif'</span>, package <span class="op">=</span> <span class="st">'mbg'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  temperature <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata/temperature.tif'</span>, package <span class="op">=</span> <span class="st">'mbg'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">covariates</span><span class="op">$</span><span class="va">intercept</span> <span class="op">&lt;-</span> <span class="va">covariates</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span> <span class="fl">0</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="co"># Administrative boundaries</span></span>
<span><span class="co"># Departments (first-level administrative divisions)</span></span>
<span><span class="va">departments</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata/Benin_departments.gpkg'</span>, package <span class="op">=</span> <span class="st">'mbg'</span><span class="op">)</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create ID raster</span></span>
<span><span class="va">id_raster</span> <span class="op">&lt;-</span> <span class="fu">mbg</span><span class="fu">::</span><span class="fu"><a href="../reference/build_id_raster.html">build_id_raster</a></span><span class="op">(</span></span>
<span>  polygons <span class="op">=</span> <span class="va">departments</span>,</span>
<span>  template_raster <span class="op">=</span> <span class="va">covariates</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="running-ml-models-with-mbg-and-caret">Running ML models with <code>mbg</code> and <code>caret</code><a class="anchor" aria-label="anchor" href="#running-ml-models-with-mbg-and-caret"></a>
</h2>
<p>The <code>mbg</code> package wraps the <a href="https://topepo.github.io/caret/" class="external-link"><code>caret</code></a> package to
run predictive models over space. The caret (Classification And
REgression Training) package contains 137 different model specifications
for regression: these include linear regression and generalized linear
models, generalized additive models, penalized regression (LASSO, ridge,
elastic net), support vector machines, regression trees, gradient
boosting, neural nets, and more.</p>
<p>You can search the full list of available regression models in the
<code>caret</code> <a href="https://topepo.github.io/caret/available-models.html" class="external-link">documentation</a>.
Note that some models have tuning parameters that can be set beforehand.
We will create a named list of <code>submodel_settings</code>, where
each name corresponds to the name of the model we will be using, and
each value is an optional named list containing any tuning parameters we
want to pass to that model.</p>
<p>Each ML model will be tuned using cross-validation. We can control
model tuning by editing <code>cross_validation_settings</code>, a named
list of arguments that will be passed to the
<code><a href="https://rdrr.io/pkg/caret/man/trainControl.html" class="external-link">caret::trainControl</a></code> function.</p>
<p>These models are fit and predictions generated across the study area
using the <code><a href="../reference/run_regression_submodels.html">run_regression_submodels()</a></code> function. This
function returns a named list with two items:</p>
<ul>
<li>
<code>"models"</code>: The fitted caret models, which can be used to
closely inspect the model results and generate new predictions</li>
<li>
<code>"predictions"</code>: Rasters containing the predictions of
the outcome generated from each model.</li>
</ul>
<p>In the code block below, we run three regression models, using child
stunting in Benin as the outcome and three covariate predictors: elastic
net (a penalized regression method), gradient boosted machines, and
bagged regression trees. We then plot the results across Benin:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Run ML models using input covariates</span></span>
<span><span class="va">cross_validation_settings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'repeatedcv'</span>, number <span class="op">=</span> <span class="fl">5</span>, repeats <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">submodel_settings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  enet <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  gbm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  treebag <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span>
<span><span class="va">submodels</span> <span class="op">&lt;-</span> <span class="fu">mbg</span><span class="fu">::</span><span class="fu"><a href="../reference/run_regression_submodels.html">run_regression_submodels</a></span><span class="op">(</span></span>
<span>  input_data <span class="op">=</span> <span class="va">outcomes</span>,</span>
<span>  id_raster <span class="op">=</span> <span class="va">id_raster</span>,</span>
<span>  covariates <span class="op">=</span> <span class="va">covariates</span>,</span>
<span>  cv_settings <span class="op">=</span> <span class="va">cross_validation_settings</span>,</span>
<span>  model_settings <span class="op">=</span> <span class="va">submodel_settings</span>,</span>
<span>  prediction_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Fitting 3 regression models</span></span>
<span><span class="co">#&gt;   Candidate model:  enet</span></span>
<span><span class="co">#&gt; Loading required package: ggplot2</span></span>
<span><span class="co">#&gt; Loading required package: lattice</span></span>
<span><span class="co">#&gt;   Candidate model:  enet: 0.932 sec elapsed</span></span>
<span><span class="co">#&gt;   Candidate model:  gbm</span></span>
<span><span class="co">#&gt;   Candidate model:  gbm: 1.825 sec elapsed</span></span>
<span><span class="co">#&gt;   Candidate model:  treebag</span></span>
<span><span class="co">#&gt;   Candidate model:  treebag: 2.508 sec elapsed</span></span>
<span><span class="co">#&gt; Fitting 3 regression models: 5.377 sec elapsed</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">submodels</span><span class="op">$</span><span class="va">predictions</span><span class="op">)</span>,</span>
<span>  main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">'Submodel prediction:'</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">submodels</span><span class="op">$</span><span class="va">predictions</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.15</span>, <span class="fl">.45</span><span class="op">)</span>,</span>
<span>  fill_range <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial-ml-models_files%2Ffigure-gfm%2Frun-ml-models-1.png"><!-- --></p>
<p>Many machine learning models are robust to handling a large feature
space, meaning that we can add more candidate predictors to the model
without over-fitting. The <code><a href="../reference/run_regression_submodels.html">run_regression_submodels()</a></code>
includes the option to add administrative boundaries to the feature
space as one-hot encoded variables. In the code block below, we use this
option to add department (first-level administrative division)
identifiers to the predictors:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">submodels_with_department_effects</span> <span class="op">&lt;-</span> <span class="fu">mbg</span><span class="fu">::</span><span class="fu"><a href="../reference/run_regression_submodels.html">run_regression_submodels</a></span><span class="op">(</span></span>
<span>  input_data <span class="op">=</span> <span class="va">outcomes</span>,</span>
<span>  id_raster <span class="op">=</span> <span class="va">id_raster</span>,</span>
<span>  covariates <span class="op">=</span> <span class="va">covariates</span>,</span>
<span>  cv_settings <span class="op">=</span> <span class="va">cross_validation_settings</span>,</span>
<span>  model_settings <span class="op">=</span> <span class="va">submodel_settings</span>,</span>
<span>  use_admin_bounds <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  admin_bounds <span class="op">=</span> <span class="va">departments</span>,</span>
<span>  admin_bounds_id <span class="op">=</span> <span class="st">'department_code'</span>,</span>
<span>  prediction_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Fitting 3 regression models</span></span>
<span><span class="co">#&gt;   Candidate model:  enet</span></span>
<span><span class="co">#&gt;   Candidate model:  enet: 1.055 sec elapsed</span></span>
<span><span class="co">#&gt;   Candidate model:  gbm</span></span>
<span><span class="co">#&gt;   Candidate model:  gbm: 2.548 sec elapsed</span></span>
<span><span class="co">#&gt;   Candidate model:  treebag</span></span>
<span><span class="co">#&gt;   Candidate model:  treebag: 3.82 sec elapsed</span></span>
<span><span class="co">#&gt; Fitting 3 regression models: 7.529 sec elapsed</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">submodels_with_department_effects</span><span class="op">$</span><span class="va">predictions</span><span class="op">)</span>,</span>
<span>  main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">'Submodel prediction:'</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">submodels_with_department_effects</span><span class="op">$</span><span class="va">predictions</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.15</span>, <span class="fl">.45</span><span class="op">)</span>,</span>
<span>  fill_range <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial-ml-models_files%2Ffigure-gfm%2Frun-with-department-effects-1.png"><!-- --></p>
</div>
<div class="section level2">
<h2 id="stacking-ml-models">Stacking ML models<a class="anchor" aria-label="anchor" href="#stacking-ml-models"></a>
</h2>
<p>The <code><a href="../reference/run_regression_submodels.html">run_regression_submodels()</a></code> function allows users to
estimate the outcome based on many different types of regression models
which may not make similar predictions across the study area. How can we
combine estimates from these models while also incorporating some of the
geostatistical principles used in the baseline <code>mbg</code> model?
One option is to use <a href="https://doi.org/10.1007/s10654-018-0390-z" class="external-link">stacked
generalization</a>, which combines model predictions to create a “super
learner” with better performance than any individual model. <a href="https://doi.org/10.1098/rsif.2017.0520" class="external-link">Previous studies</a>
indicate that this “super learner” ensemble can replace the covariate
term in a standard geostatistical model to improve prediction
accuracy.</p>
<p>To run a geostatistical model with stacked generalization, create a
<code>MbgModelRunner</code> object where
<code>use_stacking = TRUE</code>. The arguments
<code>submodel_settings</code>, <code>stacking_cv_settings</code>, and
<code>stacking_prediction_range</code> should also be set when running
stacked generalization. In the example below, we also include
administrative effects as one-hot encoded variables in the component
submodels.</p>
<p>After enabling stacking, run the
<code>MbgModelRunner$run_mbg_pipeline()</code> method to complete the
full model workflow. This will now include the following steps:</p>
<ul>
<li>Run the component regression submodels</li>
<li>For each submodel, create estimates of the outcome at each pixel
across the study area</li>
<li>Run the geostatistical model, replacing the standard covariate
effect with the “super learner” ensemble based on the regression
submodels</li>
<li>Generate final predictions from the geostatistical model</li>
</ul>
<!-- end list --><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run stacked generalization MBG model</span></span>
<span><span class="va">model_runner</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/MbgModelRunner.html">MbgModelRunner</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  input_data <span class="op">=</span> <span class="va">outcomes</span>,</span>
<span>  id_raster <span class="op">=</span> <span class="va">id_raster</span>,</span>
<span>  covariate_rasters <span class="op">=</span> <span class="va">covariates</span>,</span>
<span>  use_stacking <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  stacking_cv_settings <span class="op">=</span> <span class="va">cross_validation_settings</span>,</span>
<span>  stacking_model_settings <span class="op">=</span> <span class="va">submodel_settings</span>,</span>
<span>  stacking_prediction_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  stacking_use_admin_bounds <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  admin_bounds <span class="op">=</span> <span class="va">departments</span>,</span>
<span>  admin_bounds_id <span class="op">=</span> <span class="st">'department_code'</span></span>
<span><span class="op">)</span></span>
<span><span class="va">model_runner</span><span class="op">$</span><span class="fu">run_mbg_pipeline</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Fitting 3 regression models</span></span>
<span><span class="co">#&gt;   Candidate model:  enet</span></span>
<span><span class="co">#&gt;   Candidate model:  enet: 1.219 sec elapsed</span></span>
<span><span class="co">#&gt;   Candidate model:  gbm</span></span>
<span><span class="co">#&gt;   Candidate model:  gbm: 2.403 sec elapsed</span></span>
<span><span class="co">#&gt;   Candidate model:  treebag</span></span>
<span><span class="co">#&gt;   Candidate model:  treebag: 3.434 sec elapsed</span></span>
<span><span class="co">#&gt; Fitting 3 regression models: 7.2 sec elapsed</span></span>
<span><span class="co">#&gt; MBG model fitting</span></span>
<span><span class="co">#&gt; MBG model fitting: 12.556 sec elapsed</span></span>
<span><span class="co">#&gt; Generating model predictions</span></span>
<span><span class="co">#&gt;   Parameter posterior samples</span></span>
<span><span class="co">#&gt;   Parameter posterior samples: 5.23 sec elapsed</span></span>
<span><span class="co">#&gt;   Cell draws</span></span>
<span><span class="co">#&gt;   Cell draws: 2.128 sec elapsed</span></span>
<span><span class="co">#&gt;   Summarize draws</span></span>
<span><span class="co">#&gt;   Summarize draws: 1.447 sec elapsed</span></span>
<span><span class="co">#&gt; Generating model predictions: 8.807 sec elapsed</span></span></code></pre></div>
<p>When <code>use_stacking = TRUE</code>, the submodel predictions are
saved in the <code>MbgModelRunner$model_covariates</code> attribute.
These can be pulled and plotted:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get predictions from each component submodel</span></span>
<span><span class="va">mbg_component_models</span> <span class="op">&lt;-</span> <span class="va">model_runner</span><span class="op">$</span><span class="va">model_covariates</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">model_runner</span><span class="op">$</span><span class="va">model_covariates</span><span class="op">)</span>,</span>
<span>  range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.15</span>, <span class="fl">.45</span><span class="op">)</span>,</span>
<span>  fill_range <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial-ml-models_files%2Ffigure-gfm%2Fplot-submodels-1.png"><!-- --></p>
<p>We can also plot mean estimates from the geostatistical model. Note
how the geostatistical model blends estimates from the component
submodels, while also including other effects including the latent
spatial term and the nugget:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get predictions from the overall model</span></span>
<span><span class="va">grid_cell_predictions</span> <span class="op">&lt;-</span> <span class="va">model_runner</span><span class="op">$</span><span class="va">grid_cell_predictions</span></span>
<span><span class="co"># Plot mean estimates</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">grid_cell_predictions</span><span class="op">$</span><span class="va">cell_pred_mean</span>,</span>
<span>  main <span class="op">=</span> <span class="st">'MBG mean estimates'</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">departments</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial-ml-models_files%2Ffigure-gfm%2Fplot-model-results-1.png"><!-- --></p>
<p>As as with the default model, we can plot uncertainty by pixel:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ui_raster</span> <span class="op">&lt;-</span> <span class="va">grid_cell_predictions</span><span class="op">$</span><span class="va">cell_pred_upper</span> <span class="op">-</span> <span class="va">grid_cell_predictions</span><span class="op">$</span><span class="va">cell_pred_lower</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">ui_raster</span>,</span>
<span>  col <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html" class="external-link">sf.colors</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>  main <span class="op">=</span> <span class="st">'MBG estimates: 95% uncertainty interval width'</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">departments</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial-ml-models_files%2Ffigure-gfm%2Fplot-model-uncertainty-1.png"><!-- --></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Nathaniel Henry, Benjamin Mayala.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
