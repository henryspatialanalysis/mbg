<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>All model runner options • mbg</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Figtree-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><link href="../deps/KaTex-0.16.10/katex.min.css" rel="stylesheet">
<script src="../deps/KaTex-0.16.10/katex.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="All model runner options">
<link rel="icon" type="image/png" href="favicon-96x96.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mbg</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/mbg.html">Getting started</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-more-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">More tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-more-tutorials">
<li><a class="dropdown-item" href="../articles/spatial-ml-models.html">Running spatial ML models</a></li>
    <li><a class="dropdown-item" href="../articles/all-model-options.html">All MBG model runner options</a></li>
    <li><a class="dropdown-item" href="../articles/model-comparison.html">Model validation and comparison</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/henryspatialanalysis/mbg/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>All model runner options</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/henryspatialanalysis/mbg/blob/main/vignettes/all-model-options.Rmd" class="external-link"><code>vignettes/all-model-options.Rmd</code></a></small>
      <div class="d-none name"><code>all-model-options.Rmd</code></div>
    </div>

    
    
<p>This article breaks down all the options available when running
<code>mbg</code> models. For a summary of these terms, see the
documentation for the <a href="../reference/MbgModelRunner.html#method-new-">mbg::MBGModelRunner$new()
method</a></p>
<hr>
<div class="section level2">
<h2 id="mbg-model-basics">1: MBG model basics<a class="anchor" aria-label="anchor" href="#mbg-model-basics"></a>
</h2>
<p>The model always requires two terms: <code>input_data</code>, which
includes all point observations of the outcome to be estimated, and
<code>id_raster</code>, which lays out the study area.</p>
<div class="section level3">
<h3 id="a-input-data">1.A: Input data<a class="anchor" aria-label="anchor" href="#a-input-data"></a>
</h3>
<p>Formatted as a <code>data.frame</code> or
<code><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table::data.table</a></code>. Should contain at least the
following fields:</p>
<ul>
<li>
<code>indicator</code>: Contains the outcome to be modeled. For
binomial or Poission MBG models, this is the numerator. For Gaussian
models, this is the observed mean.</li>
<li>
<code>samplesize</code>: Only required for binomial or Poisson data.
This is the denominator for each observations.</li>
<li>
<code>sd</code>: Only required for Gaussian models. This is the
observed standard deviation for each observation.</li>
<li>
<code>x</code>: The point’s x position, in the same coordinate
reference system as the ID raster. For unprojected data, this is the
longitude</li>
<li>
<code>y</code>: The points y position, in the same coordinate
reference system as the ID raster. For unprojected data, this is the
latitude</li>
<li>
<code>cluster_id</code>: A unique identifier for each row in the
data</li>
</ul>
</div>
<div class="section level3">
<h3 id="b-id-raster">1.B: ID raster<a class="anchor" aria-label="anchor" href="#b-id-raster"></a>
</h3>
<p>A <code><a href="https://rspatial.github.io/terra/reference/SpatRaster-class.html" class="external-link">terra::SpatRaster</a></code> object meeting the following
requirements:</p>
<ul>
<li>Has a single layer</li>
<li>Covers the entire study area</li>
<li>Contains non-NA pixel values for pixels that should be estimated by
the model</li>
</ul>
<p>An ID raster can be created using the
<code><a href="../reference/build_id_raster.html">mbg::build_id_raster</a></code> function.</p>
<p>Before running a model, you could use the <code><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">terra::extract</a></code>
function to ensure that all points in your input data overlap a non-NA
pixel in the ID raster.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="model-family-and-link-function">2: Model family and link function<a class="anchor" aria-label="anchor" href="#model-family-and-link-function"></a>
</h2>
<p>The arguments <code>inla_family</code>, <code>inla_link</code>, and
<code>inverse_link</code> give the relationship between the observed
data and the linear combination of effects that make up the model. The
model defaults specify a binomial likelihood:</p>
<ul>
<li><code>inla_family = 'binomial'</code></li>
<li><code>inla_link = 'logit'</code></li>
<li><code>inverse_link = 'plogis'</code></li>
</ul>
<p>For binomial data, each data point with numerator <span class="math inline">y_i</span> and denominator <span class="math inline">N_i</span> is evaluated against a probability <span class="math inline">p_i</span>, which is governed by a logit-linear
combination of model effects:</p>
<p><span class="math display">
y_i \sim Binomial(N_i, p_i)
\\
logit(p_i) = \ ...
</span></p>
<p>The actual model effects (<span class="math inline">...</span>) are
described in the following section.</p>
<hr>
</div>
<div class="section level2">
<h2 id="model-effects">3: Model effects<a class="anchor" aria-label="anchor" href="#model-effects"></a>
</h2>
<p>The model currently has four effect types which can be toggled and
controlled via settings passed to <code><a href="../reference/MbgModelRunner.html">mbg::MbgModelRunner</a></code>.</p>
<div class="section level3">
<h3 id="a-covariate-effects">3.A: Covariate effects<a class="anchor" aria-label="anchor" href="#a-covariate-effects"></a>
</h3>
<p>Relevant settings:</p>
<ul>
<li>
<code>use_covariates</code> (default <code>TRUE</code>)</li>
<li>
<code>covariate_rasters</code> (default <code>NULL</code>)</li>
<li>
<code>use_stacking</code> (default <code>FALSE</code>)</li>
</ul>
<p>A covariate effect will only be included if
<code>use_covariates</code> is <code>TRUE</code> (the default) and
<code>covariate_rasters</code> are passed. The
<code>covariate_rasters</code> are an optional list of
<code><a href="https://rspatial.github.io/terra/reference/SpatRaster-class.html" class="external-link">terra::SpatRaster</a></code> pixel-level predictive covariates. They
can be incorporated into the model in two different ways depending on
the value of <code>use_stacking</code>:</p>
<div class="section level4">
<h4 id="a-i-standard-covariate-effect">3.A.i: Standard covariate effect<a class="anchor" aria-label="anchor" href="#a-i-standard-covariate-effect"></a>
</h4>
<p>Only applied if a covariate effect is included and
<code>use_stacking</code> is <code>FALSE</code> (the default).</p>
<p>The covariate effect at observation <span class="math inline">i</span> is <span class="math inline">\gamma^{covariates}_i = \vec{\beta}X_{s_i}</span>,
where <span class="math inline">\vec{\beta}</span> are linear effects on
the matrix of covariate values <span class="math inline">X</span>
evaluated at the location of observation <span class="math inline">i</span> (<span class="math inline">s_i</span>).</p>
<p><strong>Note that an intercept is not included by default.</strong>
If you want a model with no covariate effects other than an intercept,
pass a <code>covariate_rasters</code> with an <code>intercept</code>
raster containing all 1s.</p>
<p>A prior is applied to the variance of effects on all covariates other
than the intercept: <code>prior_covariate_effect</code> (default
<code>list(threshold = 3, prob_above = 0.05)</code>) is a <a href="https://projecteuclid.org/journals/statistical-science/volume-32/issue-1/Penalising-Model-Component-Complexity--A-Principled-Practical-Approach-to/10.1214/16-STS576.full" class="external-link">penalized
complexity prior</a> that can be expressed as a level of certainty about
the standard deviation on each fixed effect <span class="math inline">\beta</span>. For example, the default prior
corresponds to <span class="math inline">P(\sigma_{\beta} &gt; 3) =
0.05</span>.</p>
</div>
<div class="section level4">
<h4 id="a-ii-stacked-ensemble-model">3.A.ii: Stacked ensemble model<a class="anchor" aria-label="anchor" href="#a-ii-stacked-ensemble-model"></a>
</h4>
<p>Only applied if a covariate effect is included and
<code>use_stacking</code> is <code>TRUE</code>.</p>
<p>For a stacked ensemble model, the covariate effect for observation
<span class="math inline">i</span> is: <span class="math display">
\gamma^{covariates}_i = \sum_{j=1}^{J}\left[ w_{j}  f_j(X_{s_i}) \right]
\\
Constraints: w_j &gt; 0 \ \forall \ j, \ \textstyle \sum_{j=1}^{J}(w_j)
= 1
</span> Where:</p>
<ul>
<li>
<span class="math inline">\vec{f}</span>: Predictions from a set of
<em>J</em> regression models fit to the raw covariate data <span class="math inline">X</span>
</li>
<li>
<span class="math inline">\vec{w}</span>: A weighting vector
corresponding to each regression model <span class="math inline">f_j</span>. The weights are constrained to be
strictly greater than zero and to sum to one.</li>
<li>
<span class="math inline">X_{s_i}</span>: The raw covariate values
at the location of observation <span class="math inline">i</span>, <span class="math inline">s_i</span>
</li>
</ul>
<p>Relevant model settings:</p>
<ul>
<li>
<code>stacking_model_settings</code> (default
<code>list(gbm = NULL, treebag = NULL,     rf = NULL)</code>): Defines
the list of component models <span class="math inline">f_j(X)</span> to
be fitted to the covariates. A named list—each name corresponds to a <a href="https://topepo.github.io/caret/available-models.html" class="external-link">regression
model</a> in the <code>caret</code> package, and each value stores
optional settings that can be passed to that model.</li>
<li>
<code>stacking_cv_settings</code> (default
<code>list(method = 'repeatedcv', number     = 5, repeats = 5)</code>):
These are used by <code>caret::traincontrol</code> to cross-validate
each regression model</li>
<li>
<code>stacking_use_admin_bounds</code> (default <code>FALSE</code>),
<code>admin_bounds</code> (default <code>NULL</code>),
<code>admin_bounds_id</code> (default <code>NULL</code>): If
<code>stacking_use_admin_bounds</code> is <code>TRUE</code> and the
other two values are set, adds administrative fixed effects to each of
the component models.</li>
<li>
<code>stacking_prediction_range</code> (default <code>NULL</code>):
Can be used to restrict the prediction range of each component
regression model. For binomial data, a reasonable limit is to not
predict outside of <code>c(0, 1)</code>.</li>
</ul>
<hr>
</div>
</div>
<div class="section level3">
<h3 id="b-gaussian-process">3.B: Gaussian process<a class="anchor" aria-label="anchor" href="#b-gaussian-process"></a>
</h3>
<p>If the setting <code>use_gp</code> is <code>TRUE</code> (the
default), adds a spatially correlated effect:</p>
<p><span class="math display">
Z \sim GP(0, \Sigma_s)
</span> Where <span class="math inline">Z</span> is a Gaussian process
with mean zero and stationary isotropic Matern covariance over space
(<span class="math inline">\Sigma_s</span>).</p>
<p>The Gaussian process is informed by priors on the range and
variance:</p>
<ul>
<li>
<code>prior_spde_range</code> (default
<code>list(threshold = 0.1, prob_below     = 0.05)</code>) Prior on the
geostatistical range of the Gaussian process, the distance beyond which
there is little or no spatial autocorrelation between pairs of points on
the GP. This is a penalized complexity prior expressed as a named list
with two items. The <code>threshold</code> is a distance expressed
<em>relative to the diameter of the study area</em>: for example, the
default <code>threshold</code> of 0.1 corresponds to a geostatistical
range equivalent to one-tenth the diameter of the study area. The
<code>prob_below</code> is the probability that the true range falls
below this threshold. In other words, the default prior is <span class="math inline">P(range &lt; \frac{diameter}{10}) = 0.05</span>
</li>
<li>
<code>prior_spde_sigma</code> (default
<code>list(threshold = 3, prob_above     = 0.05)</code>) Penalized
complexity prior on the variance of the Gaussian process, expressed in
terms of the standard deviation <span class="math inline">\sigma_Z</span>. The default corresponds to a prior
belief that <span class="math inline">P(\sigma_Z &gt; 3) =
0.05</span>
</li>
</ul>
<p>To simplify estimation, the R-INLA package represents the continuous
Gaussian process on a 2D spatial mesh. Three more settings control the
mesh:</p>
<ul>
<li>
<code>mesh_max_edge</code> (default <code>c(0.2, 5.0)</code>): The
maximum length of a mesh edge in areas where there is little to no data.
Expressed in the same units of measurement as the projection used for
the <code>id_raster</code> (for unprojected data, this is decimal
degrees). The first term is the maximum edge length within the study
area, and the second term is the maximum edge length outside the study
area (the mesh extends beyond the study area to mitigate edge
effects).</li>
<li>
<code>mesh_cutoff</code> (default <code>0.04</code>): The minimum
length of a mesh edge in areas where data is dense. Expressed in the
same units of measurement as <code>mesh_max_edge</code>.</li>
<li>
<code>spde_integrate_to_zero</code> (default <code>FALSE</code>):
Should the volume under the fitted mesh integrate to zero?</li>
</ul>
<p>For more details about the INLA approach to approximate Gaussian
process regression, see the papers at the bottom of this page.</p>
<hr>
</div>
<div class="section level3">
<h3 id="c-administrative-level-effect">3.C: Administrative-level effect<a class="anchor" aria-label="anchor" href="#c-administrative-level-effect"></a>
</h3>
<p>This effect is a random intercept grouped by administrative unit. The
administrative level (polygon boundaries) of interest can be set by the
user. If the effect is on, then the following term is added:</p>
<p><span class="math display">
\gamma^{admin}_{a_i} \sim N(0, \sigma^2_{admin})
</span> In other words, <span class="math inline">\vec\gamma^{admin}</span> is an vector of random
intercepts with length equal to the total number of administrative
units, IID normal with mean 0 and variance <span class="math inline">\sigma^2_{admin}</span>. All observations <span class="math inline">i</span> in the same administrative division <span class="math inline">a</span> share the same intercept <span class="math inline">\gamma^{admin}_{a_i}</span>.</p>
<p>Relevant settings:</p>
<ul>
<li>
<code>use_admin_effect</code> (default <code>FALSE</code>): Should
the administrative-level effect be included in the model?</li>
<li>
<code>prior_admin_effect</code> (default
<code>list(threshold = 3, prob_above     = 0.05)</code>): A prior
applied to the administrative effect variance, expressed in terms of the
standard deviation. The default settings correspond to the prior belief
that <span class="math inline">P(\sigma_{admin} &gt; 3) =
0.05</span>
</li>
<li>
<code>admin_bounds</code> (default <code>NULL</code>):
Administrative bounds that will be used to group observations.</li>
<li>
<code>admin_bounds_id</code> (default <code>NULL</code>): Unique
identifier field for <code>admin_bounds</code>
</li>
</ul>
<hr>
</div>
<div class="section level3">
<h3 id="d-nugget">3.D: Nugget<a class="anchor" aria-label="anchor" href="#d-nugget"></a>
</h3>
<p>The nugget is an independently and identically distributed (IID)
normal effect applied to each observation. It corresponds to
“irreducible variation” not captured by any other model effect:</p>
<p><span class="math display">
\gamma^{Nugget}_i \sim N(0, \sigma^2_{nugget})
</span></p>
<p>Relevant settings:</p>
<ul>
<li>
<code>use_nugget</code> (default <code>TRUE</code>): Should the
nugget effect be included in model fitting?</li>
<li>
<code>prior_nugget</code> (default
<code>list(threshold = 3, prob_above = 0.05)</code>): A prior applied to
the nugget variance, expressed in terms of the standard deviation. The
default settings correspond to the prior belief that <span class="math inline">P(\sigma_{nugget} &gt; 3) = 0.05</span>
</li>
<li>
<code>nugget_in_predict</code> (default <code>TRUE</code>): If
<code>TRUE</code>, independent samples from <span class="math inline">N(0, \sigma^2_{nugget})</span> are added to each
pixel-level predictive draw.</li>
</ul>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="aggregation-to-polygon-boundaries">4: Aggregation to polygon boundaries<a class="anchor" aria-label="anchor" href="#aggregation-to-polygon-boundaries"></a>
</h2>
<p>As shown in the <a href="mbg.html">introductory tutorial</a>, the
<code><a href="../reference/MbgModelRunner.html">mbg::MbgModelRunner</a></code> object can automatically aggregate
predictions to administrative boundaries. The following three objects
are required to perform aggregation:</p>
<ul>
<li>
<code>aggregation_table</code>: A table created by
<code><a href="../reference/build_aggregation_table.html">mbg::build_aggregation_table</a></code>. Contains information about
the proportional area of each pixel within each administrative boundary
polygon.</li>
<li>
<code>aggregation_levels</code>: A named list, where each name
corresponds to the administrative aggregation level, and each value is a
character vector with corresponding grouping fields in the
<code>aggregation_table</code>.</li>
<li>
<code>population_raster</code>: A raster with the same dimensions as
<code>id_raster</code> that contains population estimates for each
pixel. Aggregation from pixels to administrative boundaries accounts for
varying pixel-level populations as well as fractional pixel areas.</li>
</ul>
<hr>
</div>
<div class="section level2">
<h2 id="logging">5: Logging<a class="anchor" aria-label="anchor" href="#logging"></a>
</h2>
<p>Finally, the setting <code>verbose</code> (default <code>TRUE</code>)
governs whether the model will perform detailed logging. You can access
model logs afterwards by running
<code><a href="../reference/logging_get_timer_log.html">mbg::logging_get_timer_log</a></code>.</p>
<hr>
</div>
<div class="section level2">
<h2 id="further-reading">6: Further reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<p>Bakka, H., <em>et al.</em> (2018). Spatial modeling with R‐INLA: A
review. Wiley Interdisciplinary Reviews: Computational Statistics,
10(6), e1443. <a href="https://doi.org/10.1002/wics.1443" class="external-link uri">https://doi.org/10.1002/wics.1443</a></p>
<p>Bhatt, S., Cameron, E., Flaxman, S. R., Weiss, D. J., Smith, D. L.,
&amp; Gething, P. W. (2017). <em>Improved prediction accuracy for
disease risk mapping using Gaussian process stacked generalization</em>.
Journal of The Royal Society Interface, 14(134), 20170520. <a href="https://doi.org/10.1098/rsif.2017.0520" class="external-link uri">https://doi.org/10.1098/rsif.2017.0520</a></p>
<p>Freeman, M. (2017). <em>An introduction to hierarchical
modeling</em>. <a href="http://mfviz.com/hierarchical-models/" class="external-link uri">http://mfviz.com/hierarchical-models/</a></p>
<p>Moraga, Paula. (2019). Geospatial Health Data: Modeling and
Visualization with R-INLA and Shiny. Chapman &amp; Hall/CRC
Biostatistics Series. ISBN 9780367357955. <a href="https://www.paulamoraga.com/book-geospatial/index.html" class="external-link uri">https://www.paulamoraga.com/book-geospatial/index.html</a></p>
<p>Opitz, T. (2017). <em>Latent Gaussian modeling and INLA: A review
with focus on space-time applications.</em> Journal de la société
française de statistique, 158(3), 62-85. <a href="https://www.numdam.org/article/JSFS_2017__158_3_62_0.pdf" class="external-link uri">https://www.numdam.org/article/JSFS_2017__158_3_62_0.pdf</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Nathaniel Henry, Benjamin Mayala.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
