<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Getting started with MBG • mbg</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- katex math --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Figtree-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Getting started with MBG">
<link rel="icon" type="image/png" href="favicon-96x96.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mbg</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/mbg.html">Getting started</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-more-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">More tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-more-tutorials">
<li><a class="dropdown-item" href="../articles/spatial-ml-models.html">Running spatial ML models</a></li>
    <li><a class="dropdown-item" href="../articles/all-model-options.html">All MBG model runner options</a></li>
    <li><a class="dropdown-item" href="../articles/model-comparison.html">Model validation and comparison</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/henryspatialanalysis/mbg/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Getting started with MBG</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/henryspatialanalysis/mbg/blob/main/vignettes/mbg.Rmd" class="external-link"><code>vignettes/mbg.Rmd</code></a></small>
      <div class="d-none name"><code>mbg.Rmd</code></div>
    </div>

    
    
<p>This vignette introduces <code>mbg</code>, a package for modern
Model-Based Geostatistics. This package offers tools for spatial
regression analysis:</p>
<ol style="list-style-type: decimal">
<li>Running Bayesian geostatistical models that relate
point-georeferenced outcome data to underlying spatial patterns</li>
<li>Fitting machine learning algorithms with point-georeferenced outcome
data and raster covariate data</li>
<li>Fast aggregation from (gridded, continuous) raster estimates to
(discrete) polygon boundaries, allowing for fractional splitting of
raster grid cells and population weighting. A common application for
aggregation is generating administrative summaries of fine-scale raster
data</li>
</ol>
<p><code>mbg</code> combines functions from several packages:</p>
<ul>
<li>
<code>INLA</code>: for running Bayesian geostatistical models</li>
<li>
<code>data.table</code>: for handling tabular data</li>
<li>
<code>sf</code> for handling polygons</li>
<li>
<code>terra</code> for handling raster data</li>
<li>
<code>caret</code> for running ML models with point outcomes and
raster predictors</li>
</ul>
<p>In this tutorial, we will run a simple <code>mbg</code> model with
prepared data to demonstrate core package functions.</p>
<div class="section level2">
<h2 id="setting-up">Setting up<a class="anchor" aria-label="anchor" href="#setting-up"></a>
</h2>
<p>Load the <code>mbg</code> package, as well as the
<code>data.table</code>, <code>sf</code>, and <code>terra</code>
packages for data processing, and the <code>ggplot2</code> package for
plotting.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://henryspatialanalysis.github.io/mbg/">mbg</a></span><span class="op">)</span></span></code></pre></div>
<p>For this tutorial, we will estimate stunting rates among children
under 5 years of age across Benin. Load point observations of this
outcome from the package data and print the first few rows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Outcome: child stunting</span></span>
<span><span class="va">outcomes</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata/child_stunting.csv'</span>, package <span class="op">=</span> <span class="st">'mbg'</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">cluster_id</th>
<th align="right">indicator</th>
<th align="right">samplesize</th>
<th align="right">x</th>
<th align="right">y</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">3</td>
<td align="right">5</td>
<td align="right">16</td>
<td align="right">1.762278</td>
<td align="right">6.267199</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">5</td>
<td align="right">14</td>
<td align="right">2.044534</td>
<td align="right">6.335044</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">2</td>
<td align="right">13</td>
<td align="right">2.420548</td>
<td align="right">6.346753</td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="right">1</td>
<td align="right">17</td>
<td align="right">2.371199</td>
<td align="right">6.349460</td>
</tr>
<tr class="odd">
<td align="right">7</td>
<td align="right">8</td>
<td align="right">20</td>
<td align="right">1.889197</td>
<td align="right">6.351104</td>
</tr>
<tr class="even">
<td align="right">8</td>
<td align="right">4</td>
<td align="right">23</td>
<td align="right">2.369804</td>
<td align="right">6.354230</td>
</tr>
</tbody>
</table>
<p>The outcome data has 505 rows, each representing one surveyed
location, and five columns:</p>
<ul>
<li>
<strong>cluster_id</strong>: A unique identifier for each surveyed
location</li>
<li>
<strong>samplesize</strong>: The number of children under 5 surveyed
at the location</li>
<li>
<strong>indicator</strong>: The outcome of interest—in this case,
the number of sampled children who met the definition for stunting</li>
<li>
<strong>x</strong>: The surveyed location’s longitude</li>
<li>
<strong>y</strong>: The surveyed location’s latitude</li>
</ul>
<p>Let’s map this survey data over a map of Benin.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Administrative boundaries</span></span>
<span><span class="va">communes</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata/Benin_communes.gpkg'</span>, package <span class="op">=</span> <span class="st">'mbg'</span><span class="op">)</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert point data to sf</span></span>
<span><span class="va">outcome_sf</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span></span>
<span>  <span class="va">outcomes</span>,</span>
<span>  coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'x'</span>, <span class="st">'y'</span><span class="op">)</span>,</span>
<span>  crs <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">communes</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">outcome_sf</span><span class="op">$</span><span class="va">stunting_rate</span> <span class="op">&lt;-</span> <span class="va">outcome_sf</span><span class="op">$</span><span class="va">indicator</span> <span class="op">/</span> <span class="va">outcome_sf</span><span class="op">$</span><span class="va">samplesize</span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">communes</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">outcome_sf</span>,</span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">stunting_rate</span>, size <span class="op">=</span> <span class="va">samplesize</span><span class="op">)</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.75</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_size.html" class="external-link">scale_size_continuous</a></span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_color_gradientn</a></span><span class="op">(</span></span>
<span>    colors <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mappal.html" class="external-link">map.pal</a></span><span class="op">(</span><span class="st">'viridis'</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">'Stunting point data'</span>,</span>
<span>    color <span class="op">=</span> <span class="st">'Observed\nstunting\nrate'</span>,</span>
<span>    size <span class="op">=</span> <span class="st">'Sample\nsize'</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="mbg_files/figure-gfm/plot-outcome-data-1.png"><!-- --></p>
<p>We can see that there seem to be spatial patterns in the surveyed
stunting data—stunting generally seems to be lower around the urban
regions of Porto Novo in the coastal south and Parakou in the center
north, and higher in the far north and the inland south. To better
understand the underlying trends in stunting risk across the country, we
would ideally like to:</p>
<ul>
<li>Adjust for noise in the outcome due to small sample sizes in the
point-level survey data;</li>
<li>Understand likely stunting risk not just at surveyed points, but at
locations across the entire country;</li>
<li>Incorporate data about possible predictors of child stunting and
spatial trends to inform our estimates, and;</li>
<li>Propagate uncertainty due to small sample sizes, uncertain predictor
relationships, and distance to data points into our estimates for all
locations.</li>
</ul>
<p>A Bayesian geostatistical model can accomplish all of these goals. We
will fit a Bayesian geostatistical model to the outcome data, with three
potential predictors formatted as raster surfaces:</p>
<ol style="list-style-type: decimal">
<li>Travel time to the nearest city, in minutes</li>
<li>Enhanced vegetation index (EVI)</li>
<li>Mean annual temperature</li>
</ol>
<!-- end list --><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Spatial covariates</span></span>
<span><span class="va">covariates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  access <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata/access.tif'</span>, package <span class="op">=</span> <span class="st">'mbg'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  evi <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata/evi.tif'</span>, package <span class="op">=</span> <span class="st">'mbg'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  temperature <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata/temperature.tif'</span>, package <span class="op">=</span> <span class="st">'mbg'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Plot the covariates</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">covariates</span><span class="op">)</span>, nr <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="mbg_files/figure-gfm/load-covariates-1.png"><!-- --></p>
<div class="section level3">
<h3 id="building-mbg-model-inputs">Building MBG model inputs<a class="anchor" aria-label="anchor" href="#building-mbg-model-inputs"></a>
</h3>
<p>The geostatistical model takes three more arguments:</p>
<ol style="list-style-type: decimal">
<li>
<code>id_raster</code>: A <code><a href="https://rspatial.github.io/terra/reference/SpatRaster-class.html" class="external-link">terra::SpatRaster</a></code> that lays
out the prediction grid. The model will make predictions for all non-NA
cells in the <code>id_raster</code>.</li>
<li>
<code>aggregation_table</code> (<code><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table::data.table</a></code>,
optional): Used to aggregate model estimates from grid cells to commune
polygons, preserving uncertainty</li>
<li>
<code>population_raster</code> (<code><a href="https://rspatial.github.io/terra/reference/SpatRaster-class.html" class="external-link">terra::SpatRaster</a></code>,
optional): population-based indicators like child stunting should be
aggregated using population weighting, which places greater weight on
grid cells with higher populations when summarizing those grid cell
results by polygon.</li>
</ol>
<!-- end list --><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create ID raster</span></span>
<span><span class="va">id_raster</span> <span class="op">&lt;-</span> <span class="fu">mbg</span><span class="fu">::</span><span class="fu"><a href="../reference/build_id_raster.html">build_id_raster</a></span><span class="op">(</span></span>
<span>  polygons <span class="op">=</span> <span class="va">communes</span>,</span>
<span>  template_raster <span class="op">=</span> <span class="va">covariates</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Table to help with aggregation to higher administrative levels</span></span>
<span><span class="va">aggregation_table</span> <span class="op">&lt;-</span> <span class="fu">mbg</span><span class="fu">::</span><span class="fu"><a href="../reference/build_aggregation_table.html">build_aggregation_table</a></span><span class="op">(</span></span>
<span>  polygons <span class="op">=</span> <span class="va">communes</span>,</span>
<span>  id_raster <span class="op">=</span> <span class="va">id_raster</span>,</span>
<span>  polygon_id_field <span class="op">=</span> <span class="st">'commune_code'</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Population raster: used for aggregation to administrative boundaries</span></span>
<span><span class="va">population_raster</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata/under_5_population.tif'</span>, package <span class="op">=</span> <span class="st">'mbg'</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="fit-the-geostatistical-model">Fit the geostatistical model<a class="anchor" aria-label="anchor" href="#fit-the-geostatistical-model"></a>
</h2>
<p>The entire Bayesian geostatistical regression workflow can be run
using the <code><a href="../reference/MbgModelRunner.html">mbg::MbgModelRunner</a></code> class. The
<code>MbgModelRunner$new()</code> method creates a new instance of the
class, and the <code>MbgModelRunner$run_mbg_pipeline()</code> runs the
entire workflow based on the passed inputs.</p>
<p>The following code block runs the <code>mbg</code> model using mainly
default settings. A typical workflow can take a few minutes to finish,
although intermediate steps will be printed to screen. Because we want a
regression intercept in this model, the first line in the code block
below creates the intercept as one of the covariate rasters.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add an intercept to the model</span></span>
<span><span class="va">covariates</span><span class="op">$</span><span class="va">intercept</span> <span class="op">&lt;-</span> <span class="va">covariates</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span> <span class="fl">0</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="co">## Run MBG models</span></span>
<span><span class="va">model_runner</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/MbgModelRunner.html">MbgModelRunner</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  input_data <span class="op">=</span> <span class="va">outcomes</span>,</span>
<span>  id_raster <span class="op">=</span> <span class="va">id_raster</span>,</span>
<span>  covariate_rasters <span class="op">=</span> <span class="va">covariates</span>,</span>
<span>  aggregation_table <span class="op">=</span> <span class="va">aggregation_table</span>,</span>
<span>  aggregation_levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    commune <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'commune_code'</span>, <span class="st">'commune'</span>, <span class="st">'department_code'</span>, <span class="st">'department'</span><span class="op">)</span>,</span>
<span>    region <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'department_code'</span>, <span class="st">'department'</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  population_raster <span class="op">=</span> <span class="va">population_raster</span></span>
<span><span class="op">)</span></span>
<span><span class="va">model_runner</span><span class="op">$</span><span class="fu">run_mbg_pipeline</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; MBG model fitting</span></span>
<span><span class="co">#&gt; MBG model fitting: 13.857 sec elapsed</span></span>
<span><span class="co">#&gt; Generating model predictions</span></span>
<span><span class="co">#&gt;   Parameter posterior samples</span></span>
<span><span class="co">#&gt;   Parameter posterior samples: 6.415 sec elapsed</span></span>
<span><span class="co">#&gt;   Cell draws</span></span>
<span><span class="co">#&gt;   Cell draws: 2.123 sec elapsed</span></span>
<span><span class="co">#&gt;   Summarize draws</span></span>
<span><span class="co">#&gt;   Summarize draws: 0.817 sec elapsed</span></span>
<span><span class="co">#&gt; Generating model predictions: 9.357 sec elapsed</span></span>
<span><span class="co">#&gt; Running population-weighted aggregation from grid cells to polygons</span></span></code></pre></div>
<div class="section level3">
<h3 id="plot-gridded-estimates">Plot gridded estimates<a class="anchor" aria-label="anchor" href="#plot-gridded-estimates"></a>
</h3>
<p>The model makes predictions at each grid cell, with some uncertainty
associated with each grid cell prediction. We capture that uncertainty
by taking many (by default, 250) samples from the range of plausible
model estimates and generating summary statistics across those
samples.</p>
<p>Once the geostatistical workflow has finished, we can pull the
gridded raster model predictions from the
<code>MbgModelRunner$grid_cell_predictions</code> attribute. This
attribute is a list with the following items:</p>
<ul>
<li>
<code>'parameter_draws'</code> (<code>matrix</code>): Samples of the
underlying model parameters</li>
<li>
<code>'cell_draws'</code> (<code>matrix</code>): Samples of model
estimates at each grid cell location from the
<code>id_raster</code>
</li>
<li>
<code>'cell_pred_mean'</code> (<code><a href="https://rspatial.github.io/terra/reference/SpatRaster-class.html" class="external-link">terra::SpatRaster</a></code>): The
mean estimates across all sampled <code>cell_draws</code>, represented
as a raster.</li>
<li>
<code>'cell_pred_lower'</code> (<code><a href="https://rspatial.github.io/terra/reference/SpatRaster-class.html" class="external-link">terra::SpatRaster</a></code>):
Lower bounds of an uncertainty interval, summarized across the sampled
<code>cell_draws</code> and represented as a raster. By default, we use
a 95% uncertainty interval, so this raster shows the 2.5th percentile
across the samples for each grid cell.</li>
<li>
<code>'cell_pred_upper'</code> (<code><a href="https://rspatial.github.io/terra/reference/SpatRaster-class.html" class="external-link">terra::SpatRaster</a></code>):
Upper bounds of the uncertainty interval, represented as a raster. By
default, shows the 97.5th percentile of samples for each grid cell.</li>
</ul>
<p>We can plot the mean estimates from the geostatistical model:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get predictions by pixel</span></span>
<span><span class="va">grid_cell_predictions</span> <span class="op">&lt;-</span> <span class="va">model_runner</span><span class="op">$</span><span class="va">grid_cell_predictions</span></span>
<span><span class="co"># Plot mean estimates</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">grid_cell_predictions</span><span class="op">$</span><span class="va">cell_pred_mean</span> <span class="op">*</span> <span class="fl">100</span>,</span>
<span>  main <span class="op">=</span> <span class="st">'MBG mean estimates (%)'</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">communes</span><span class="op">)</span></span></code></pre></div>
<p><img src="mbg_files/figure-gfm/plot-pixel-mean-predictions-1.png"><!-- --></p>
<p>We can also show the width of the 95% uncertainty interval by
subtracting the “lower” from the “upper” summary raster:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot estimate uncertainty</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="op">(</span><span class="va">grid_cell_predictions</span><span class="op">$</span><span class="va">cell_pred_upper</span> <span class="op">-</span> <span class="va">grid_cell_predictions</span><span class="op">$</span><span class="va">cell_pred_lower</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>,</span>
<span>  col <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html" class="external-link">sf.colors</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>  main <span class="op">=</span> <span class="st">'MBG estimates: 95% uncertainty interval width (%)'</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">communes</span><span class="op">)</span></span></code></pre></div>
<p><img src="mbg_files/figure-gfm/plot-pixel-ui-predictions-1.png"><!-- --></p>
<p>Compare these gridded estimates to the underlying point data. The
results seem to meet our goals for estimating stunting risk across
Benin:</p>
<ol style="list-style-type: decimal">
<li>Gridded estimates are available for every region in Benin, not just
at survey points</li>
<li>The mean estimates for stunting risk show a similar spatial pattern
to the underlying point data</li>
<li>Some extreme values from the point data, which may have been noisy
due to small sample sizes, have been smoothed out in these
estimates</li>
<li>Model uncertainty, as shown by the width of the 95% uncertainty
interval, is higher in areas that were far from any surveyed
points.</li>
<li>Underlying relationships between the raster predictors and the point
outcomes seem to have influenced estimates: for example, locations with
a higher travel time to cities generally also have higher estimated
stunting risk.</li>
</ol>
<p>Many of these observations can be quantified and tested, as
demonstrated in later vignettes.</p>
</div>
<div class="section level3">
<h3 id="plot-aggregated-estimates">Plot aggregated estimates<a class="anchor" aria-label="anchor" href="#plot-aggregated-estimates"></a>
</h3>
<p>Each sample from the geostatistical model yields a <em>candidate
map</em>, a single realization of the outcome across each pixel in the
study area that is consistent with the fitted model parameters and
uncertainty. These samples can be individually aggregated to
administrative boundaries, preserving uncertainty, and then
summarized.</p>
<p>Aggregated samples and summaries are available from the
<code>MbgModelRunner$aggregated_predictions</code> attribute. This
attribute is a named list, where each item contains polygon estimates
for each of the passed <code>aggregation_levels</code>. Each of those
levels has two items:</p>
<ul>
<li>
<code>'draws'</code> (<code><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table::data.table</a></code>):
Predictive model samples by aggregated polygon unit</li>
<li>
<code>'summary'</code> (<code><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table::data.table</a></code>):
Summaries of <code>draws</code> for each aggregated polygon unit,
including the mean and the bounds of the 95% uncertainty interval across
samples</li>
</ul>
<p>We can merge the commune estimate summaries back onto the
<code>communes</code> sf object to plot the results.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get predictions by commune</span></span>
<span><span class="va">aggregated_predictions</span> <span class="op">&lt;-</span> <span class="va">model_runner</span><span class="op">$</span><span class="va">aggregated_predictions</span></span>
<span><span class="va">commune_summary</span> <span class="op">&lt;-</span> <span class="va">aggregated_predictions</span><span class="op">$</span><span class="va">commune</span><span class="op">$</span><span class="va">summary</span></span>
<span><span class="va">summary_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/merge.html" class="external-link">merge</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">communes</span>,</span>
<span>  y <span class="op">=</span> <span class="va">commune_summary</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'commune_code'</span>, <span class="st">'commune'</span>, <span class="st">'department_code'</span>, <span class="st">'department'</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Plot aggregated estimates by commune</span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">summary_sf</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">'black'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradientn</a></span><span class="op">(</span></span>
<span>    colors <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mappal.html" class="external-link">map.pal</a></span><span class="op">(</span><span class="st">'viridis'</span><span class="op">)</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.15</span>, <span class="fl">0.45</span>, by <span class="op">=</span> <span class="fl">.05</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">'MBG mean estimates by commune'</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Estimated\nstunting\nrate"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="mbg_files/figure-gfm/plot-commune-mean-predictions-1.png"><!-- --></p>
<p>We can also plot the width of the 95% uncertainty interval by
commune.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot aggregated uncertainty interval widths by commune</span></span>
<span><span class="va">summary_sf</span><span class="op">$</span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="va">summary_sf</span><span class="op">$</span><span class="va">upper</span> <span class="op">-</span> <span class="va">summary_sf</span><span class="op">$</span><span class="va">lower</span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">summary_sf</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">ui</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">'black'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradientn</a></span><span class="op">(</span></span>
<span>    colors <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html" class="external-link">sf.colors</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">'MBG 95% uncertainty interval width by commune'</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">'Uncertainty\ninterval\nwidth'</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="mbg_files/figure-gfm/plot-commune-ui-widths-1.png"><!-- --></p>
<p>Note that in general, uncertainty intervals tend to be wider at the
pixel level than for aggregated polygons. This is because some sources
of uncertainty are uncorrelated between pixels, and this uncorrelated
uncertainty shrinks when estimates are aggregated across pixels.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Nathaniel Henry, Benjamin Mayala.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
